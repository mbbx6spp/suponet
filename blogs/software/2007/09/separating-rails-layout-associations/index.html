

  
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html">
  <link href="/images/favicon.ico" rel="shortcut icon">
  <meta content="width=device-width, minimum-scale=1.0, maximum-scale=1.5" name="viewport">
  <title>Susan Potter: Separating Rails Layout Associations</title>
  <link rel="stylesheet" type="text/css" href="/stylesheets/reset.css">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="/stylesheets/styles.css">
  <link rel="stylesheet" type="text/css" href="/stylesheets/coderay.css">


  
    <header>
  <div class="container">
    <a href="/">
      <img alt="Susan Potter" height="30" src="/images/logo.png" width="128">
    </a>
    <nav>
      <a href="/about/">About</a>
      <a href="/resume/">Resume</a>
      <a href="/portfolio/">Portfolio</a>
      <a href="/talks/">Talks</a>
      <a href="/contact/">Contact</a>
      <a target="_blank" id="twitter" class="icon" href="https://twitter.com/SusanPotter"><img src="/images/twitter.png" height="30" width="30" alt="@SusanPotter's Twitter feed"></a>
      <a target="_blank" id="linked" class="icon" href="https://www.linkedin.com/in/susanpotter"><img src="/images/linkedin.png" height="30" width="30" alt="Susan Potter's LinkedIn profile"></a>
      <a target="_blank" id="github" class="icon" href="https://github.com/mbbx6spp"><img src="/images/github.png" height="30" width="30" alt="Susan Potter's GitHub open source code repository profile"></a>
    </nav>
  </div>
</header>


    <div class="text post sidebar">
      <aside class=".hidden-xs .hidden-sm">
        <ul class="share-buttons">
          <li class="twitter"><a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical" data-via="SusanPotter">Tweet</a></li>
          <li class="plusone">
          <li class="linked">
<script type="text/javascript" src="https://platform.linkedin.com/in.js"></script><script type="in/share" data-counter="top"></script>
</li>
        </ul>
      </aside>
      <section>
        <article>
          <h1 class="banner">
            Software Development Blog <small>(formerly called 'Snakes, Gems &amp; Coffee')</small>
            <span class="description">
              A technical blog with articles on a number of topics from Erlang, Ruby idioms, Javascript,
              semantic web, Rails tips, graph databases, distributed systems.
            </span>
          </h1>
          
          <h2>Separating Rails Layout Associations</h2>
          <h5 class="time">2007-09-13 21:16:00 -0500</h5>
          I just realized I hadn't shared this code yet on this blog.  I will also be including it in one of the
%a{:href =&gt; "http://metafusion.rubyforge.org"} metafusion
subprojects (coming soon).  I've been using it when needed in my Rails projects on and off for the last several months.
%h4&gt; The Problem
You have some controllers you include into your application from plugins or engines and you want to associate a particular layout to the plugin/engine controller from within your application (without changing anything in the plugin or engine - of course!).  There is not good way of doing this nicely in Rails presently as each controller usually defines controller-wide layouts within its definition.
%h4 The Solution
%pre
  [finsignia/paths.rb]
  %code
    :preserve
      
      # See:
      # * Finsignia::Paths
      
      # Contains helper methods related to paths and resolving modules and 
      # classes from paths.  Provides for helpful mixin for various applications.
      module Finsignia::Paths
      
        def self.included(base)
          base.extend ClassMethods
        end
        
        # Contains class methods for Finsignia::Paths mixin
        module ClassMethods
          @@element_postfixes = {:model =&gt; '', :controller =&gt; 'Controller'}
      
          def resolve_model(path)
            resolve_element :model, path
          end
        
          def resolve_controller(path)
            resolve_element :controller, path
          end
          
          def normalize_module_name(path)
            list = path.split('_')
            list.collect do |item|
              item.capitalize
            end.join
          end
          
          # Resolves path to a type of Rails element 
          # (e.g. model, controller, etc.).
          # 
          # Path refers to 'internal' path, NOT require path:
          #  'users/users' #=&gt; internal path
          #  'users/users_controller #=&gt; require path
          def resolve_element(type, path)
            first, rest = path.split('/')
            mod = ObjectSpace.const_get(normalize_module_name(first))
            while rest
              first, rest = rest.split('/')
      
              unless rest
                mod = mod.const_get(normalize_module_name("\#{first}_\#{@@element_postfixes[type].downcase}"))
              else
                mod = mod.const_get(normalize_module_name(first))
              end
              # I doubt this will ever get this far as per expeceted behavior of ObjectSpace and Module...so commented it out following unreachable line.
              #raise NameError.new("\#{type} constant not found for internal path \#{path}") unless mod
              return mod unless rest
            end      
          end
          
          # Separating this so we can stub this method out in specifications.
          def require_controller(path)
            require("\#{path}_controller") unless "test" == ENV["RAILS_ENV"]
          end
          
          # Separating this so we can stub this method out in specifications.
          def require_model(path)
            require(path) unless "test" == ENV["RAILS_ENV"]
          end
        end
      end
  [finsignia/layouts.rb]
  %code
    :preserve
      
      # See:
      # * Finsignia::Layouts
      # * Finsignia::LayoutsError
      
      # Raised when an exceptional condition arises in the Layouts 
      # mapping process.
      class Finsignia::LayoutsError &lt; Exception; end
      
      # Provides a closure and declarative way to define layout
      # mappings for an application that utilize controllers, views, 
      # etc. from plugins.
      #
      # The closure approach simulates the Rails Routing approach 
      # closely, like:
      #  require 'application'
      #  
      #  Finsignia::Layouts.map do |map|
      #    map.connect 'users/sessions', 'layout_name'
      #  end
      #
      # The declarative approach looks like the following:
      #  require 'application'
      #  include Finsignia
      #  Layouts.map 'users/sessions', 'layout_name'
      # 
      module Finsignia::Layouts
        class &lt;&lt; self
          def connect(controller_path, layout)
            require_controller(controller_path)
            # resolve controller class and call .layout(layout) on it.
            controller = resolve_controller(controller_path)
            controller.layout(layout)
          end
          
          def map(&amp;block)
            yield self if block_given?
          end
        end
      
      #  private
          include Finsignia::Paths    
      end
So basically in a file like
%tt config/layouts.rb
of our application we have something like:
%pre
  %code
    :preserve
      
      Finsignia::Layouts.map do |map|
        map.connect 'users/sessions', 'session'
        map.connect 'users/users', 'users'
        map.connect 'accounts/transaction', 'account'
      end
Then include the
%tt config/layouts.rb
file in
%tt config/environment.rb
and you have separated your concerns relatively nicely and easily.

When I release metafusion-rails my plan is that instead of installing the
%tt finsignia/paths.rb
and
%tt finsignia/layouts.rb
in the
%tt lib
directory you would be able to do something like the following at the end of your
%tt config/environment.rb
file:
%pre
  %code
    :preserve
      
      gem('metafusion-rails', '=MFR_VERSION')
      require 'metafusion/rails'
      
      Finsignia::Layouts.map do |map|
        map.connect 'namespace/resource', 'layout'
        # etc....
      end
Alternatively you could still keep the layouts.rb file if your environment.rb is getting large and keep the layouts.rb include in your environment.rb.

        </article>
      </section>
    </div>
    <footer>
  <p>
    Copyright Â© 2006-2018 <a href="//susanpotter.net">Susan Potter</a>.
  </p>
  <p>
    This website is developed by <a href="//susanpotter.net">Susan Potter</a>.
  </p>
  <div id="rights">
    <a href="//susanpotter.net">Susan Potter</a> reserves all rights to the copy and intellectual rights that are presented on this website as original material to <a href="//susanpotter.net">Susan Potter</a>.
    Links: <a href="//susanpotter.net/resume/software-engineering/">Software Engineer Extraordinaire</a>,
           <a href="//susanpotter.net/resume/software-engineering/">Software Developer Extraordinaire</a>,
           <a href="//susanpotter.net/resume/software-engineering/">Software Engineer</a>,
           <a href="//susanpotter.net/resume/architect/">Application architect/</a>,
           <a href="//susanpotter.net/resume/software-engineering/">Ruby Software Engineer</a>,
           <a href="//susanpotter.net/resume/software-engineering/">Ruby Engineer</a>,
           <a href="//susanpotter.net/resume/software-engineering/">Ruby on Rails Engineer</a>,
           <a href="//susanpotter.net/resume/software-engineering/">Ruby on Rails Software Engineer</a>,
           <a href="//susanpotter.net/resume/software-engineering/">Software Developer</a>,
           <a href="//susanpotter.net/resume/architect/">Software architect/</a>,
           <a href="//susanpotter.net/resume/software-engineering/">Hedge Fund Software Engineer</a>,
           <a href="//susanpotter.net/resume/software-engineering/">Hedge Fund Software Developer</a>,
           <a href="//susanpotter.net/">Web Services Software Engineer</a>,
           <a href="//susanpotter.net/">Web Services Software Developer</a>,
           <a href="//susanpotter.net/">Web Services Engineer</a>,
           <a href="//susanpotter.net/">Web Services Developer</a>,
           <a href="//susanpotter.net/resume/restful-design/">REST Software Engineer</a>,
           <a href="//susanpotter.net/resume/restful-design/">REST Software Developer</a>,
           <a href="//susanpotter.net/resume/restful-design/">Resource Oriented architect/ure</a>,
  </div>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-837842-1', 'auto');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');
  </script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.6/jquery.min.js"></script>
  
  
  <script async="async" defer src="/javascripts/app.js"></script>
  <script>
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>
</footer>

    <script type="text/javascript">
      (function($) {
        var btns = $('.share-buttons .plusone').html('<g:plusone size="tall"></g:plusone>');
        var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
        po.src = 'https://apis.google.com/js/plusone.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
      })(jQuery);
    </script>
    <!-- Place this tag just before your close body tag -->
  

