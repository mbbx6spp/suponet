

  
  <meta charset="utf-8">
  <meta http-equiv="content-type" content="text/html">
  <link href="/images/favicon.ico" rel="shortcut icon">
  <meta content="width=device-width, minimum-scale=1.0, maximum-scale=1.5" name="viewport">
  <title>Susan Potter: 'Twas the night before launch...</title>
  <link rel="stylesheet" type="text/css" href="/stylesheets/reset.css">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="/stylesheets/styles.css">
  <link rel="stylesheet" type="text/css" href="/stylesheets/coderay.css">


  
    <header>
  <div class="container">
    <a href="/">
      <img alt="Susan Potter" height="30" src="/images/logo.png" width="128">
    </a>
    <nav>
      <a href="/about/">About</a>
      <a href="/resume/">Resume</a>
      <a href="/portfolio/">Portfolio</a>
      <a href="/talks/">Talks</a>
      <a href="/contact/">Contact</a>
      <a target="_blank" id="twitter" class="icon" href="https://twitter.com/SusanPotter"><img src="/images/twitter.png" height="30" width="30" alt="@SusanPotter's Twitter feed"></a>
      <a target="_blank" id="linked" class="icon" href="https://www.linkedin.com/in/susanpotter"><img src="/images/linkedin.png" height="30" width="30" alt="Susan Potter's LinkedIn profile"></a>
      <a target="_blank" id="github" class="icon" href="https://github.com/mbbx6spp"><img src="/images/github.png" height="30" width="30" alt="Susan Potter's GitHub open source code repository profile"></a>
    </nav>
  </div>
</header>


    <div class="text post sidebar">
      <aside class=".hidden-xs .hidden-sm">
        <ul class="share-buttons">
          <li class="twitter"><a href="https://twitter.com/share" class="twitter-share-button" data-count="vertical" data-via="SusanPotter">Tweet</a></li>
          <li class="plusone">
          <li class="linked">
<script type="text/javascript" src="https://platform.linkedin.com/in.js"></script><script type="in/share" data-counter="top"></script>
</li>
        </ul>
      </aside>
      <section>
        <article>
          <h1 class="banner">
            Software Development Blog <small>(formerly called 'Snakes, Gems &amp; Coffee')</small>
            <span class="description">
              A technical blog with articles on a number of topics from Erlang, Ruby idioms, Javascript,
              semantic web, Rails tips, graph databases, distributed systems.
            </span>
          </h1>
          
          <h2>'Twas the night before launch...</h2>
          <h5 class="time">2008-01-04 19:10:00 -0600</h5>
          Oh fun times!  On such fateful nights you know you will find something that will screw things up unless immediately addressed.  It must be someone's law already, but if it isn't I call dibs on it and it should thus be called
= succeed ":)." do
  %b "Potter's Law"
On a night before launch that I recently experienced, I had a heart stopping moment.  The last 5 days of the sprint I had been churning out last minute changes based on usability feedback from the client.  In the process, I had neglected to include benchmarking and memory leak testing with the same discipline I prefer.  On the night before launch I ran my usual benchmarking scripts.  The results were pretty good except on one action.  We could have lived with that performance, but the real problem came when I ran tests to detect memory leaks in my Rails application.  Let the real fun begin!

Before continuing, I should mention there is only thing I hate more than uber visual tasks (editing/creating graphics, layout tweaking, etc.) and that is debugging memory leaks.

I ran the
%code ab
(Apache Bench) utility on a few different types of pages in the staging environment and didn't notice any problems.  The Rails application was consistently teetering under 50M RAM.  Excellent!  Then I tried the second most requested type of page (this was a static site we were rewriting in Rails to create an easy to use domain-specific CMS - so we had live production web statistics) and my heart skipped a beat or three.

Memory usage spiraled out of control.  From 49.5M the single mongrel process eventually grew to 250M after a few
%code ab -c2 -n100 ....
runs.

I first checked out the view since I knew the controller action code was only 6 lines (how much could go wrong there?).

I tried removing different parts of the view code and rerunning my tests while monitoring the memory usage of the process.  Still no change.

So I reluctantly looked in the controller and saw something like the following:
%pre
  %code
    :preserve
      
        def show
          @eto = ExchangeTradedOption.find_active(params[:id])
      
          respond_to do |format|
            format.html # show.rhtml
            format.xml  { render :action =&gt; "xml", :layout =&gt; false }
            format.csv  { render :action =&gt; "csv", :layout =&gt; false }
          end
        end
What on earth was in the
%code ExchangeTradedOption.find_active
method?
%pre
  %code
    :preserve
      
        class &lt;&lt; self
          def find_active(id)
            now = Time.now
            find(
              id,
              :include =&gt; [:exchange, {:vendor_symbols =&gt; [:vendor]}],
              :conditions =&gt; [
                %{options.expires_at &lt;= ? AND options.active = 1 AND 
                  vendor_symbols.effective_date &lt;= ? AND vendor_symbols.expiration_date &gt;= ?}, 
                now, now, now
              ],
              :order =&gt; 'vendor_symbols.effective_date DESC'
            )
          end
        end
Ouch!  The problem was that I still needed all vendor symbols and vendors for the view in question and didn't want to make the extra SQL queries for the Vendor on each VendorSymbol as that would have added between 5-10 extra SQL queries per action invocation.

I guessed the nested includes in the find was most likely to be causing the issue.  So I refactored as followed:
%pre
  %code
    :preserve
      
      # Controller action code: ExchangeTradedOptionsController#show
        def show
          @eto = ExchangeTradedOption.find_active(params[:id])
          @vendor_symbols = VendorSymbol.find_active_for(params[:id])
      
          respond_to do |format|
            format.html # show.rhtml
            format.xml  { render :action =&gt; "xml", :layout =&gt; false }
            format.csv  { render :action =&gt; "csv", :layout =&gt; false }
          end
        end
      
      # Model finder code: ExchangeTradedOption.find_active
        class &lt;&lt; self
          def find_active(id)
            now = Time.now
            find(
              id,
              :include =&gt; [:exchange],
              :conditions =&gt; [%{options.expires_at &lt;= ? AND options.active = 1}, now],
            )
          end
        end
      
      # The VendorSymbol.find_active_for method implementation is left as an exercise for the reader
      # but it is very, very simple!
      
      # Changed view to refer to @vendor_symbols array instead of @eto.vendor_symbols
      # This also helped reduce indirection and prevented Law of Demeter violations in the view code!
Of course, I didn't leave it without verifying!  Never just guess that the problem is solved, you should always verify this with tests (either automated or manual).

There were a few solutions, of course.  One is the one I provided above.  The second solution I thought of trying was removing the
%code vendor_symbols
SQL conditions and sorting in Ruby.  This seemed a waste of CPU to me and extra lines of code I felt was unnecessary (remember the less code you write the less you need to maintain!).  The third solution was to execute an optimized raw SQL query myself.  I also didn't like this option as the first one presented about seemed cleaner and more maintainable going forward.  The first solution does cause more than one SQL query to be executed each time the action is run, but it is scalable as it remains constant at two queries per invocation.  In addition I added one extra instance variable, which is also not ideal, but again this didn't seem to me to be the worst problem at this stage with only two instance variables in the action being set for the view.

The benchmarking results proved my assumptions correct regarding the various solutions.

The moral of the story is find the best solution based on the context rather than attempting to apply a
%b one-query-per-action-invocation
rule to the whole application, which might be ideal, but occasionally unrealistic and/or catastrophic.

        </article>
      </section>
    </div>
    <footer>
  <p>
    Copyright Â© 2006-2018 <a href="//susanpotter.net">Susan Potter</a>.
  </p>
  <p>
    This website is developed by <a href="//susanpotter.net">Susan Potter</a>.
  </p>
  <div id="rights">
    <a href="//susanpotter.net">Susan Potter</a> reserves all rights to the copy and intellectual rights that are presented on this website as original material to <a href="//susanpotter.net">Susan Potter</a>.
    Links: <a href="//susanpotter.net/resume/software-engineering/">Software Engineer Extraordinaire</a>,
           <a href="//susanpotter.net/resume/software-engineering/">Software Developer Extraordinaire</a>,
           <a href="//susanpotter.net/resume/software-engineering/">Software Engineer</a>,
           <a href="//susanpotter.net/resume/architect/">Application architect/</a>,
           <a href="//susanpotter.net/resume/software-engineering/">Ruby Software Engineer</a>,
           <a href="//susanpotter.net/resume/software-engineering/">Ruby Engineer</a>,
           <a href="//susanpotter.net/resume/software-engineering/">Ruby on Rails Engineer</a>,
           <a href="//susanpotter.net/resume/software-engineering/">Ruby on Rails Software Engineer</a>,
           <a href="//susanpotter.net/resume/software-engineering/">Software Developer</a>,
           <a href="//susanpotter.net/resume/architect/">Software architect/</a>,
           <a href="//susanpotter.net/resume/software-engineering/">Hedge Fund Software Engineer</a>,
           <a href="//susanpotter.net/resume/software-engineering/">Hedge Fund Software Developer</a>,
           <a href="//susanpotter.net/">Web Services Software Engineer</a>,
           <a href="//susanpotter.net/">Web Services Software Developer</a>,
           <a href="//susanpotter.net/">Web Services Engineer</a>,
           <a href="//susanpotter.net/">Web Services Developer</a>,
           <a href="//susanpotter.net/resume/restful-design/">REST Software Engineer</a>,
           <a href="//susanpotter.net/resume/restful-design/">REST Software Developer</a>,
           <a href="//susanpotter.net/resume/restful-design/">Resource Oriented architect/ure</a>,
  </div>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-837842-1', 'auto');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');
  </script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.6/jquery.min.js"></script>
  
  
  <script async="async" defer src="/javascripts/app.js"></script>
  <script>
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>
</footer>

    <script type="text/javascript">
      (function($) {
        var btns = $('.share-buttons .plusone').html('<g:plusone size="tall"></g:plusone>');
        var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
        po.src = 'https://apis.google.com/js/plusone.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
      })(jQuery);
    </script>
    <!-- Place this tag just before your close body tag -->
  

